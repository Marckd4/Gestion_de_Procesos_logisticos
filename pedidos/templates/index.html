{% extends 'base.html' %}

{% block content %}

<h1 class="mb-4"></h1>

<div class="row mb-3">
    <div class="col-md-6">
        <input type="text" id="filtroTabla" class="form-control"
               placeholder="üîç Buscar en la tabla...">
    </div>

    <div class="col-md-6 text-end">
        <button class="btn btn-primary ms-2" onclick="exportarExcel()">
            üì§ Exportar Excel
        </button>
    </div>
</div>

<div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
    <table id="tablaPedidos" class="table table-striped table-bordered table-hover align-middle">
        <thead class="table-dark" style="position: sticky; top: 0; z-index: 1;">
            <tr>
                <th>Fecha</th>
                <th>Cod DUN</th>
                <th>Cod EAN</th>
                <th>Cod Sistema</th>
                <th>Descripci√≥n</th>
                <th>√Årea</th>
                <th>Solicitante</th>
                <th>Cantidad</th>
                <th>Prioridad</th>
                <th>Enviada BSF</th>
                <th>Chofer</th>
                <th>Factura / Gu√≠a</th>
                <th>Acciones</th>
            </tr>
        </thead>

        <tbody>
            {% for p in pedidos %}
            <tr>
                <td>{{ p.fecha_solicitud|date:"d-m-Y H:i" }}</td>
                <td>{{ p.cod_dun }}</td>
                <td>{{ p.cod_ean }}</td>
                <td>{{ p.cod_sistema }}</td>
                <td>{{ p.descripcion }}</td>
                <td>{{ p.area_solicitud }}</td>
                <td>{{ p.nombre_solicitante }}</td>
                <td>{{ p.cantidad_solicitada }}</td>
                <td>{{ p.status_prioridades }}</td>
                <td>{{ p.cant_enviada_bsf }}</td>
                <td>{{ p.chofer }}</td>
                <td>{{ p.factura_guia }}</td>
                <td class="text-center">
                    <a href="{% url 'pedido_editar' p.id %}" class="btn btn-warning btn-sm">
                        ‚úèÔ∏è
                    </a>
                    <a href="{% url 'pedido_eliminar' p.id %}"
                       class="btn btn-danger btn-sm"
                       onclick="return confirm('¬øSeguro que deseas eliminar este registro?')">
                        üóëÔ∏è
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Librer√≠a para exportar Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Filtro general -->
<script>
document.getElementById("filtroTabla").addEventListener("keyup", function () {
    let filtro = this.value.toLowerCase();
    let filas = document.querySelectorAll("#tablaPedidos tbody tr");

    filas.forEach(fila => {
        let textoFila = fila.innerText.toLowerCase();
        fila.style.display = textoFila.includes(filtro) ? "" : "none";
    });
});
</script>

<!-- Exportar Excel -->
<script>
function exportarExcel() {
    let tabla = document.getElementById("tablaPedidos");
    let wb = XLSX.utils.table_to_book(tabla, { sheet: "Solicitudes" });
    XLSX.writeFile(wb, "solicitudes_mercaderia.xlsx");
}
</script>

{% endblock %}
